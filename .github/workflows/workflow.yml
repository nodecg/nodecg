name: Build, Test, and Release

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [10.x, 12.x]

    steps:
    - uses: actions/checkout@v2
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}
    - run: npm ci
    - run: npm run build
    - name: Upload math result for job 1
      uses: actions/upload-artifact@v1
      with:
        name: build
        path: ./

  test:
    runs-on: ubuntu-latest
    
    needs: build

    strategy:
      matrix:
        node-version: [10.x, 12.x]

    steps:
    - name: Download build
      uses: actions/download-artifact@v1
      with:
        name: build
    - run: npm test
      
  release:
    runs-on: ubuntu-latest
    
    needs: build
    
    steps:
    - name: Download build
      uses: actions/download-artifact@v1
      with:
        name: build
    - name: Semantic Release
      uses: cycjimmy/semantic-release-action@v2.4.1
      with:
        branches: | 
          [
            '+([0-9])?(.{+([0-9]),x}).x',
            'master',
            'next',
            'next-major',
            {
              name: 'beta', 
              prerelease: true
            },
            {
              name: 'alpha',
              prerelease: true
            }
          ]
        extra_plugins: |
          [
            '@semantic-release/commit-analyzer',
            '@semantic-release/release-notes-generator',
            '@semantic-release/npm',
            '@semantic-release/github'
          ]
    
    - run: nyc report --reporter=text-lcov > coverage.lcov
    - name: Report code coverage to Codecov
    - uses: codecov/codecov-action@v1
      with:
        file: ./coverage.lcov # optional
