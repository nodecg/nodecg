{"version":3,"file":"hubextensions.js","sources":["../../../src/tracing/hubextensions.ts"],"sourcesContent":["import type { ClientOptions, CustomSamplingContext, TransactionContext } from '@sentry/types';\nimport { logger } from '@sentry/utils';\n\nimport { DEBUG_BUILD } from '../debug-build';\nimport type { Hub } from '../hub';\nimport { getMainCarrier } from '../hub';\nimport { registerErrorInstrumentation } from './errors';\nimport { IdleTransaction } from './idletransaction';\nimport { sampleTransaction } from './sampling';\nimport { Transaction } from './transaction';\n\n/** Returns all trace headers that are currently on the top scope. */\nfunction traceHeaders(this: Hub): { [key: string]: string } {\n  const scope = this.getScope();\n  const span = scope.getSpan();\n\n  return span\n    ? {\n        'sentry-trace': span.toTraceparent(),\n      }\n    : {};\n}\n\n/**\n * Creates a new transaction and adds a sampling decision if it doesn't yet have one.\n *\n * The Hub.startTransaction method delegates to this method to do its work, passing the Hub instance in as `this`, as if\n * it had been called on the hub directly. Exists as a separate function so that it can be injected into the class as an\n * \"extension method.\"\n *\n * @param this: The Hub starting the transaction\n * @param transactionContext: Data used to configure the transaction\n * @param CustomSamplingContext: Optional data to be provided to the `tracesSampler` function (if any)\n *\n * @returns The new transaction\n *\n * @see {@link Hub.startTransaction}\n */\nfunction _startTransaction(\n  this: Hub,\n  transactionContext: TransactionContext,\n  customSamplingContext?: CustomSamplingContext,\n): Transaction {\n  const client = this.getClient();\n  const options: Partial<ClientOptions> = (client && client.getOptions()) || {};\n\n  const configInstrumenter = options.instrumenter || 'sentry';\n  const transactionInstrumenter = transactionContext.instrumenter || 'sentry';\n\n  if (configInstrumenter !== transactionInstrumenter) {\n    DEBUG_BUILD &&\n      logger.error(\n        `A transaction was started with instrumenter=\\`${transactionInstrumenter}\\`, but the SDK is configured with the \\`${configInstrumenter}\\` instrumenter.\nThe transaction will not be sampled. Please use the ${configInstrumenter} instrumentation to start transactions.`,\n      );\n\n    transactionContext.sampled = false;\n  }\n\n  let transaction = new Transaction(transactionContext, this);\n  transaction = sampleTransaction(transaction, options, {\n    parentSampled: transactionContext.parentSampled,\n    transactionContext,\n    ...customSamplingContext,\n  });\n  if (transaction.sampled) {\n    transaction.initSpanRecorder(options._experiments && (options._experiments.maxSpans as number));\n  }\n  if (client && client.emit) {\n    client.emit('startTransaction', transaction);\n  }\n  return transaction;\n}\n\n/**\n * Create new idle transaction.\n */\nexport function startIdleTransaction(\n  hub: Hub,\n  transactionContext: TransactionContext,\n  idleTimeout: number,\n  finalTimeout: number,\n  onScope?: boolean,\n  customSamplingContext?: CustomSamplingContext,\n  heartbeatInterval?: number,\n): IdleTransaction {\n  const client = hub.getClient();\n  const options: Partial<ClientOptions> = (client && client.getOptions()) || {};\n\n  let transaction = new IdleTransaction(transactionContext, hub, idleTimeout, finalTimeout, heartbeatInterval, onScope);\n  transaction = sampleTransaction(transaction, options, {\n    parentSampled: transactionContext.parentSampled,\n    transactionContext,\n    ...customSamplingContext,\n  });\n  if (transaction.sampled) {\n    transaction.initSpanRecorder(options._experiments && (options._experiments.maxSpans as number));\n  }\n  if (client && client.emit) {\n    client.emit('startTransaction', transaction);\n  }\n  return transaction;\n}\n\n/**\n * Adds tracing extensions to the global hub.\n */\nexport function addTracingExtensions(): void {\n  const carrier = getMainCarrier();\n  if (!carrier.__SENTRY__) {\n    return;\n  }\n  carrier.__SENTRY__.extensions = carrier.__SENTRY__.extensions || {};\n  if (!carrier.__SENTRY__.extensions.startTransaction) {\n    carrier.__SENTRY__.extensions.startTransaction = _startTransaction;\n  }\n  if (!carrier.__SENTRY__.extensions.traceHeaders) {\n    carrier.__SENTRY__.extensions.traceHeaders = traceHeaders;\n  }\n\n  registerErrorInstrumentation();\n}\n"],"names":[],"mappings":"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"}