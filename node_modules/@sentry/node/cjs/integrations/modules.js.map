{"version":3,"file":"modules.js","sources":["../../../src/integrations/modules.ts"],"sourcesContent":["import { existsSync, readFileSync } from 'fs';\nimport { dirname, join } from 'path';\nimport type { Event, EventProcessor, Hub, Integration } from '@sentry/types';\n\nlet moduleCache: { [key: string]: string };\n\n/** Extract information about paths */\nfunction getPaths(): string[] {\n  try {\n    return require.cache ? Object.keys(require.cache as Record<string, unknown>) : [];\n  } catch (e) {\n    return [];\n  }\n}\n\n/** Extract information about package.json modules */\nfunction collectModules(): {\n  [name: string]: string;\n} {\n  const mainPaths = (require.main && require.main.paths) || [];\n  const paths = getPaths();\n  const infos: {\n    [name: string]: string;\n  } = {};\n  const seen: {\n    [path: string]: boolean;\n  } = {};\n\n  paths.forEach(path => {\n    let dir = path;\n\n    /** Traverse directories upward in the search of package.json file */\n    const updir = (): void | (() => void) => {\n      const orig = dir;\n      dir = dirname(orig);\n\n      if (!dir || orig === dir || seen[orig]) {\n        return undefined;\n      }\n      if (mainPaths.indexOf(dir) < 0) {\n        return updir();\n      }\n\n      const pkgfile = join(orig, 'package.json');\n      seen[orig] = true;\n\n      if (!existsSync(pkgfile)) {\n        return updir();\n      }\n\n      try {\n        const info = JSON.parse(readFileSync(pkgfile, 'utf8')) as {\n          name: string;\n          version: string;\n        };\n        infos[info.name] = info.version;\n      } catch (_oO) {\n        // no-empty\n      }\n    };\n\n    updir();\n  });\n\n  return infos;\n}\n\n/** Fetches the list of modules and the versions loaded by the entry file for your node.js app. */\nfunction _getModules(): { [key: string]: string } {\n  if (!moduleCache) {\n    moduleCache = collectModules();\n  }\n  return moduleCache;\n}\n\n/** Add node modules / packages to the event */\nexport class Modules implements Integration {\n  /**\n   * @inheritDoc\n   */\n  public static id: string = 'Modules';\n\n  /**\n   * @inheritDoc\n   */\n  public name: string = Modules.id;\n\n  /**\n   * @inheritDoc\n   */\n  public setupOnce(_addGlobalEventProcessor: (callback: EventProcessor) => void, getCurrentHub: () => Hub): void {\n    // noop\n  }\n\n  /** @inheritdoc */\n  public processEvent(event: Event): Event {\n    return {\n      ...event,\n      modules: {\n        ...event.modules,\n        ..._getModules(),\n      },\n    };\n  }\n}\n"],"names":["path","dirname","join","existsSync","readFileSync"],"mappings":"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"}